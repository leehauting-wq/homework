<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功課管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">📚 功課管理系統</h1>
            <p class="text-gray-600">輕鬆管理每日功課、追蹤進度</p>
        </div>

        <!-- 導航選單 -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button onclick="showSection('homework')" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                📝 發佈功課
            </button>
            <button onclick="showSection('missing')" class="nav-btn bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                ⚠️ 欠交記錄
            </button>
            <button onclick="showSection('graded')" class="nav-btn bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                ✅ 批改完成
            </button>
            <button onclick="showSection('summary')" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                📊 月度總結
            </button>
            <button onclick="showSection('manage')" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                🗂️ 記錄管理
            </button>
        </div>

        <!-- 發佈功課區域 -->
        <div id="homework-section" class="section bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                📝 發佈功課
            </h2>
            <form id="homework-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                        <input type="date" id="homework-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                        <select id="homework-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">請選擇科目</option>
                            <option value="中文">中文</option>
                            <option value="英文">英文</option>
                            <option value="數學">數學</option>
                            <option value="常識">常識</option>
                            <option value="人文">人文</option>
                            <option value="科學">科學</option>
                            <option value="電腦">電腦</option>
                            <option value="班務">班務</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">功課內容</label>
                    <textarea id="homework-content" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="請輸入功課內容..."></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-colors">
                    發佈功課
                </button>
            </form>
        </div>

        <!-- 欠交記錄區域 -->
        <div id="missing-section" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                ⚠️ 欠交記錄
            </h2>
            <form id="missing-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                        <input type="date" id="missing-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                        <select id="missing-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="">請選擇科目</option>
                            <option value="中文">中文</option>
                            <option value="英文">英文</option>
                            <option value="數學">數學</option>
                            <option value="常識">常識</option>
                            <option value="人文">人文</option>
                            <option value="科學">科學</option>
                            <option value="電腦">電腦</option>
                            <option value="班務">班務</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">學生姓名</label>
                        <input type="text" id="missing-student" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="請輸入學生姓名">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">欠交功課</label>
                    <input type="text" id="missing-homework" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="請輸入欠交的功課內容">
                </div>
                <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-medium transition-colors">
                    記錄欠交
                </button>
            </form>
        </div>

        <!-- 批改完成區域 -->
        <div id="graded-section" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                ✅ 批改完成
            </h2>
            <form id="graded-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                        <input type="date" id="graded-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                        <select id="graded-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">請選擇科目</option>
                            <option value="中文">中文</option>
                            <option value="英文">英文</option>
                            <option value="數學">數學</option>
                            <option value="常識">常識</option>
                            <option value="人文">人文</option>
                            <option value="科學">科學</option>
                            <option value="電腦">電腦</option>
                            <option value="班務">班務</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">批改數量</label>
                        <input type="number" id="graded-count" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入批改數量">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">功課內容</label>
                    <input type="text" id="graded-homework" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="請輸入批改的功課內容">
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition-colors">
                    記錄批改
                </button>
            </form>
        </div>

        <!-- 月度總結區域 -->
        <div id="summary-section" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                📊 月度總結
            </h2>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">選擇月份</label>
                <input type="month" id="summary-month" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="updateSummary()">
            </div>
            <div id="summary-stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- 統計卡片將在這裡動態生成 -->
            </div>
            <div class="flex gap-4">
                <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    📊 匯出Excel
                </button>
            </div>
        </div>

        <!-- 記錄管理區域 -->
        <div id="manage-section" class="section bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                🗂️ 記錄管理
            </h2>
            <div class="mb-6">
                <div class="flex flex-wrap gap-4 mb-4">
                    <select id="manage-type" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent" onchange="loadManageRecords()">
                        <option value="homework">發佈功課</option>
                        <option value="missing">欠交記錄</option>
                        <option value="graded">批改完成</option>
                    </select>
                    <input type="month" id="manage-month" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent" onchange="loadManageRecords()">
                </div>
            </div>
            <div id="manage-records" class="space-y-4">
                <!-- 記錄將在這裡動態生成 -->
            </div>
        </div>
    </div>

    <!-- 編輯模態框 -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">編輯記錄</h3>
            <div id="edit-form-content">
                <!-- 編輯表單將在這裡動態生成 -->
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="saveEdit()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-colors">
                    保存
                </button>
                <button onclick="closeEditModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-colors">
                    取消
                </button>
            </div>
        </div>
    </div>

    <script>
        // 數據存儲
        let homeworkData = JSON.parse(localStorage.getItem('homeworkData')) || [];
        let missingData = JSON.parse(localStorage.getItem('missingData')) || [];
        let gradedData = JSON.parse(localStorage.getItem('gradedData')) || [];
        let currentEditRecord = null;
        let currentEditType = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 設置默認日期為今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('homework-date').value = today;
            document.getElementById('missing-date').value = today;
            document.getElementById('graded-date').value = today;
            
            // 設置默認月份為當前月份
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('summary-month').value = currentMonth;
            document.getElementById('manage-month').value = currentMonth;
            
            updateSummary();
            loadManageRecords();
        });

        // 顯示區域
        function showSection(section) {
            // 隱藏所有區域
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            // 顯示選中區域
            document.getElementById(section + '-section').classList.remove('hidden');
            
            // 更新導航按鈕樣式
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white');
            });
            event.target.classList.add('ring-2', 'ring-white');
        }

        // 發佈功課
        document.getElementById('homework-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('homework-date').value;
            const subject = document.getElementById('homework-subject').value;
            const content = document.getElementById('homework-content').value;
            
            if (!date || !subject || !content) {
                alert('請填寫所有欄位！');
                return;
            }
            
            const record = {
                id: Date.now(),
                date: date,
                subject: subject,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            homeworkData.push(record);
            localStorage.setItem('homeworkData', JSON.stringify(homeworkData));
            
            alert('功課發佈成功！');
            this.reset();
            document.getElementById('homework-date').value = new Date().toISOString().split('T')[0];
        });

        // 記錄欠交
        document.getElementById('missing-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('missing-date').value;
            const subject = document.getElementById('missing-subject').value;
            const student = document.getElementById('missing-student').value;
            const homework = document.getElementById('missing-homework').value;
            
            if (!date || !subject || !student || !homework) {
                alert('請填寫所有欄位！');
                return;
            }
            
            const record = {
                id: Date.now(),
                date: date,
                subject: subject,
                student: student,
                homework: homework,
                timestamp: new Date().toISOString()
            };
            
            missingData.push(record);
            localStorage.setItem('missingData', JSON.stringify(missingData));
            
            alert('欠交記錄已保存！');
            this.reset();
            document.getElementById('missing-date').value = new Date().toISOString().split('T')[0];
        });

        // 記錄批改
        document.getElementById('graded-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('graded-date').value;
            const subject = document.getElementById('graded-subject').value;
            const count = document.getElementById('graded-count').value;
            const homework = document.getElementById('graded-homework').value;
            
            if (!date || !subject || !count || !homework) {
                alert('請填寫所有欄位！');
                return;
            }
            
            const record = {
                id: Date.now(),
                date: date,
                subject: subject,
                count: parseInt(count),
                homework: homework,
                timestamp: new Date().toISOString()
            };
            
            gradedData.push(record);
            localStorage.setItem('gradedData', JSON.stringify(gradedData));
            
            alert('批改記錄已保存！');
            this.reset();
            document.getElementById('graded-date').value = new Date().toISOString().split('T')[0];
        });

        // 更新月度總結
        function updateSummary() {
            const selectedMonth = document.getElementById('summary-month').value;
            if (!selectedMonth) return;
            
            const [year, month] = selectedMonth.split('-');
            
            // 篩選該月份的數據
            const monthHomework = homeworkData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            const monthMissing = missingData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            const monthGraded = gradedData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            
            // 計算統計數據
            const totalHomework = monthHomework.length;
            const totalMissing = monthMissing.length;
            const totalGraded = monthGraded.reduce((sum, record) => sum + record.count, 0);
            
            // 生成統計卡片
            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500 cursor-pointer hover:bg-blue-100 transition-colors" onclick="showDetailRecords('homework', '${selectedMonth}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-600 text-sm font-medium">發佈功課</p>
                            <p class="text-3xl font-bold text-blue-800">${totalHomework}</p>
                        </div>
                        <div class="text-blue-500 text-2xl">📝</div>
                    </div>
                </div>
                <div class="bg-red-50 p-6 rounded-lg border-l-4 border-red-500 cursor-pointer hover:bg-red-100 transition-colors" onclick="showDetailRecords('missing', '${selectedMonth}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-600 text-sm font-medium">欠交記錄</p>
                            <p class="text-3xl font-bold text-red-800">${totalMissing}</p>
                        </div>
                        <div class="text-red-500 text-2xl">⚠️</div>
                    </div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500 cursor-pointer hover:bg-green-100 transition-colors" onclick="showDetailRecords('graded', '${selectedMonth}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-600 text-sm font-medium">批改完成</p>
                            <p class="text-3xl font-bold text-green-800">${totalGraded}</p>
                        </div>
                        <div class="text-green-500 text-2xl">✅</div>
                    </div>
                </div>
            `;
        }

        // 顯示詳細記錄
        function showDetailRecords(type, month) {
            document.getElementById('manage-type').value = type;
            document.getElementById('manage-month').value = month;
            loadManageRecords();
            showSection('manage');
        }

        // 載入管理記錄
        function loadManageRecords() {
            const type = document.getElementById('manage-type').value;
            const month = document.getElementById('manage-month').value;
            
            let data = [];
            switch(type) {
                case 'homework':
                    data = homeworkData;
                    break;
                case 'missing':
                    data = missingData;
                    break;
                case 'graded':
                    data = gradedData;
                    break;
            }
            
            // 篩選該月份的記錄
            const filteredData = month ? 
                data.filter(record => record.date.startsWith(month)) : 
                data;
            
            const container = document.getElementById('manage-records');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">暫無記錄</p>';
                return;
            }
            
            container.innerHTML = filteredData.map(record => {
                let content = '';
                switch(type) {
                    case 'homework':
                        content = `
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${record.subject} - ${record.date}</div>
                                <div class="text-gray-600 text-sm mt-1">${record.content}</div>
                            </div>
                        `;
                        break;
                    case 'missing':
                        content = `
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${record.subject} - ${record.date}</div>
                                <div class="text-gray-600 text-sm mt-1">學生：${record.student}</div>
                                <div class="text-gray-600 text-sm">欠交：${record.homework}</div>
                            </div>
                        `;
                        break;
                    case 'graded':
                        content = `
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${record.subject} - ${record.date}</div>
                                <div class="text-gray-600 text-sm mt-1">數量：${record.count} 份</div>
                                <div class="text-gray-600 text-sm">內容：${record.homework}</div>
                            </div>
                        `;
                        break;
                }
                
                return `
                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                        ${content}
                        <div class="flex gap-2">
                            <button onclick="editRecord('${type}', ${record.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                編輯
                            </button>
                            <button onclick="deleteRecord('${type}', ${record.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                刪除
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 編輯記錄
        function editRecord(type, id) {
            let data = [];
            switch(type) {
                case 'homework':
                    data = homeworkData;
                    break;
                case 'missing':
                    data = missingData;
                    break;
                case 'graded':
                    data = gradedData;
                    break;
            }
            
            const record = data.find(r => r.id === id);
            if (!record) return;
            
            currentEditRecord = record;
            currentEditType = type;
            
            let formContent = '';
            switch(type) {
                case 'homework':
                    formContent = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                                <input type="date" id="edit-date" value="${record.date}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                                <select id="edit-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="中文" ${record.subject === '中文' ? 'selected' : ''}>中文</option>
                                    <option value="英文" ${record.subject === '英文' ? 'selected' : ''}>英文</option>
                                    <option value="數學" ${record.subject === '數學' ? 'selected' : ''}>數學</option>
                                    <option value="常識" ${record.subject === '常識' ? 'selected' : ''}>常識</option>
                                    <option value="人文" ${record.subject === '人文' ? 'selected' : ''}>人文</option>
                                    <option value="科學" ${record.subject === '科學' ? 'selected' : ''}>科學</option>
                                    <option value="電腦" ${record.subject === '電腦' ? 'selected' : ''}>電腦</option>
                                    <option value="班務" ${record.subject === '班務' ? 'selected' : ''}>班務</option>
                                    <option value="其他" ${record.subject === '其他' ? 'selected' : ''}>其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">內容</label>
                                <textarea id="edit-content" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${record.content}</textarea>
                            </div>
                        </div>
                    `;
                    break;
                case 'missing':
                    formContent = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                                <input type="date" id="edit-date" value="${record.date}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                                <select id="edit-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="中文" ${record.subject === '中文' ? 'selected' : ''}>中文</option>
                                    <option value="英文" ${record.subject === '英文' ? 'selected' : ''}>英文</option>
                                    <option value="數學" ${record.subject === '數學' ? 'selected' : ''}>數學</option>
                                    <option value="常識" ${record.subject === '常識' ? 'selected' : ''}>常識</option>
                                    <option value="人文" ${record.subject === '人文' ? 'selected' : ''}>人文</option>
                                    <option value="科學" ${record.subject === '科學' ? 'selected' : ''}>科學</option>
                                    <option value="電腦" ${record.subject === '電腦' ? 'selected' : ''}>電腦</option>
                                    <option value="班務" ${record.subject === '班務' ? 'selected' : ''}>班務</option>
                                    <option value="其他" ${record.subject === '其他' ? 'selected' : ''}>其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">學生姓名</label>
                                <input type="text" id="edit-student" value="${record.student}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">欠交功課</label>
                                <input type="text" id="edit-homework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    `;
                    break;
                case 'graded':
                    formContent = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                                <input type="date" id="edit-date" value="${record.date}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                                <select id="edit-subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="中文" ${record.subject === '中文' ? 'selected' : ''}>中文</option>
                                    <option value="英文" ${record.subject === '英文' ? 'selected' : ''}>英文</option>
                                    <option value="數學" ${record.subject === '數學' ? 'selected' : ''}>數學</option>
                                    <option value="常識" ${record.subject === '常識' ? 'selected' : ''}>常識</option>
                                    <option value="人文" ${record.subject === '人文' ? 'selected' : ''}>人文</option>
                                    <option value="科學" ${record.subject === '科學' ? 'selected' : ''}>科學</option>
                                    <option value="電腦" ${record.subject === '電腦' ? 'selected' : ''}>電腦</option>
                                    <option value="班務" ${record.subject === '班務' ? 'selected' : ''}>班務</option>
                                    <option value="其他" ${record.subject === '其他' ? 'selected' : ''}>其他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">批改數量</label>
                                <input type="number" id="edit-count" value="${record.count}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">功課內容</label>
                                <input type="text" id="edit-homework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('edit-form-content').innerHTML = formContent;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        // 保存編輯
        function saveEdit() {
            if (!currentEditRecord || !currentEditType) return;
            
            const date = document.getElementById('edit-date').value;
            const subject = document.getElementById('edit-subject').value;
            
            if (!date || !subject) {
                alert('請填寫所有必填欄位！');
                return;
            }
            
            // 更新記錄
            switch(currentEditType) {
                case 'homework':
                    const content = document.getElementById('edit-content').value;
                    if (!content) {
                        alert('請填寫功課內容！');
                        return;
                    }
                    currentEditRecord.date = date;
                    currentEditRecord.subject = subject;
                    currentEditRecord.content = content;
                    localStorage.setItem('homeworkData', JSON.stringify(homeworkData));
                    break;
                case 'missing':
                    const student = document.getElementById('edit-student').value;
                    const homework = document.getElementById('edit-homework').value;
                    if (!student || !homework) {
                        alert('請填寫所有欄位！');
                        return;
                    }
                    currentEditRecord.date = date;
                    currentEditRecord.subject = subject;
                    currentEditRecord.student = student;
                    currentEditRecord.homework = homework;
                    localStorage.setItem('missingData', JSON.stringify(missingData));
                    break;
                case 'graded':
                    const count = document.getElementById('edit-count').value;
                    const gradedHomework = document.getElementById('edit-homework').value;
                    if (!count || !gradedHomework) {
                        alert('請填寫所有欄位！');
                        return;
                    }
                    currentEditRecord.date = date;
                    currentEditRecord.subject = subject;
                    currentEditRecord.count = parseInt(count);
                    currentEditRecord.homework = gradedHomework;
                    localStorage.setItem('gradedData', JSON.stringify(gradedData));
                    break;
            }
            
            closeEditModal();
            loadManageRecords();
            updateSummary();
            alert('記錄已更新！');
        }

        // 關閉編輯模態框
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
            currentEditRecord = null;
            currentEditType = null;
        }

        // 刪除記錄
        function deleteRecord(type, id) {
            if (!confirm('確定要刪除這筆記錄嗎？')) return;
            
            switch(type) {
                case 'homework':
                    homeworkData = homeworkData.filter(record => record.id !== id);
                    localStorage.setItem('homeworkData', JSON.stringify(homeworkData));
                    break;
                case 'missing':
                    missingData = missingData.filter(record => record.id !== id);
                    localStorage.setItem('missingData', JSON.stringify(missingData));
                    break;
                case 'graded':
                    gradedData = gradedData.filter(record => record.id !== id);
                    localStorage.setItem('gradedData', JSON.stringify(gradedData));
                    break;
            }
            
            loadManageRecords();
            updateSummary();
            alert('記錄已刪除！');
        }

        // 匯出Excel
        function exportToExcel() {
            const selectedMonth = document.getElementById('summary-month').value;
            if (!selectedMonth) {
                alert('請選擇要匯出的月份！');
                return;
            }
            
            // 篩選該月份的數據
            const monthHomework = homeworkData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            const monthMissing = missingData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            const monthGraded = gradedData.filter(record => 
                record.date.startsWith(selectedMonth)
            );
            
            // 創建工作簿
            const wb = XLSX.utils.book_new();
            
            // 發佈功課工作表
            const homeworkWS = XLSX.utils.json_to_sheet(
                monthHomework.map(record => ({
                    '日期': record.date,
                    '科目': record.subject,
                    '功課內容': record.content
                }))
            );
            XLSX.utils.book_append_sheet(wb, homeworkWS, '發佈功課');
            
            // 欠交記錄工作表
            const missingWS = XLSX.utils.json_to_sheet(
                monthMissing.map(record => ({
                    '日期': record.date,
                    '科目': record.subject,
                    '學生姓名': record.student,
                    '欠交功課': record.homework
                }))
            );
            XLSX.utils.book_append_sheet(wb, missingWS, '欠交記錄');
            
            // 批改完成工作表
            const gradedWS = XLSX.utils.json_to_sheet(
                monthGraded.map(record => ({
                    '日期': record.date,
                    '科目': record.subject,
                    '批改數量': record.count,
                    '功課內容': record.homework
                }))
            );
            XLSX.utils.book_append_sheet(wb, gradedWS, '批改完成');
            
            // 下載文件
            const fileName = `功課管理記錄_${selectedMonth}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // 點擊模態框外部關閉
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9826ccac7644f4f8',t:'MTc1ODQyODczNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
