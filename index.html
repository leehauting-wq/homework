<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¸æ•™å¸«åŠŸèª²ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“š åŠŸèª²ç®¡ç†ç³»çµ±</h1>
            <p class="text-gray-600">è¼•é¬†ç®¡ç†æ¯æ—¥åŠŸèª²ã€è¿½è¹¤é€²åº¦</p>
        </div>

        <!-- æ—¥æœŸå’Œæœˆä»½é¸æ“‡å™¨ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“… é¸æ“‡æ—¥æœŸ</h2>
                    <input type="date" id="selectedDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">ğŸ“Š æŸ¥çœ‹æœˆä»½ç¸½çµ</h2>
                    <input type="month" id="selectedMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('homework')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">ğŸ“ ä»Šæ—¥åŠŸèª²</h3>
                        <p class="text-3xl font-bold text-blue-600" id="homeworkCount">0</p>
                    </div>
                    <div class="text-4xl">ğŸ“‹</div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('missing')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">âš ï¸ æ¬ äº¤è¨˜éŒ„</h3>
                        <p class="text-3xl font-bold text-red-600" id="missingCount">0</p>
                    </div>
                    <div class="text-4xl">ğŸ“Š</div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('graded')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">âœ… å·²æ‰¹æ”¹</h3>
                        <p class="text-3xl font-bold text-green-600" id="gradedCount">0</p>
                    </div>
                    <div class="text-4xl">âœ¨</div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div id="mainContent">
            <!-- åŠŸèƒ½é¸é …å¡ -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="flex border-b">
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-500 text-blue-600" data-tab="homework">ğŸ“ ç™¼ä½ˆåŠŸèª²</button>
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700" data-tab="missing">âš ï¸ æ¬ äº¤è¿½è¹¤</button>
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700" data-tab="graded">âœ… æ‰¹æ”¹è¨˜éŒ„</button>
                </div>
            </div>

            <!-- ç™¼ä½ˆåŠŸèª² -->
            <div id="homeworkTab" class="tab-content bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“ ç™¼ä½ˆæ–°åŠŸèª²</h3>
                <form id="homeworkForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®</label>
                            <select id="homeworkSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜">å¸¸è­˜</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="ç§‘å­¸">ç§‘å­¸</option>
                                <option value="é›»è…¦">é›»è…¦</option>
                                <option value="ç­å‹™">ç­å‹™</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆªæ­¢æ—¥æœŸ</label>
                            <input type="date" id="homeworkDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŠŸèª²å…§å®¹</label>
                        <textarea id="homeworkContent" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥åŠŸèª²è©³ç´°å…§å®¹..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">ğŸ“ ç™¼ä½ˆåŠŸèª²</button>
                </form>
            </div>

            <!-- æ¬ äº¤è¿½è¹¤ -->
            <div id="missingTab" class="tab-content bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">âš ï¸ è¨˜éŒ„æ¬ äº¤å­¸ç”Ÿ</h3>
                <form id="missingForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®</label>
                            <select id="missingSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜">å¸¸è­˜</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="ç§‘å­¸">ç§‘å­¸</option>
                                <option value="é›»è…¦">é›»è…¦</option>
                                <option value="ç­å‹™">ç­å‹™</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¸ç”Ÿå§“å</label>
                            <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¬ äº¤åŠŸèª²</label>
                        <input type="text" id="missingHomework" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="è«‹è¼¸å…¥æ¬ äº¤çš„åŠŸèª²å…§å®¹">
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors font-medium">âš ï¸ è¨˜éŒ„æ¬ äº¤</button>
                </form>
            </div>

            <!-- æ‰¹æ”¹è¨˜éŒ„ -->
            <div id="gradedTab" class="tab-content bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">âœ… è¨˜éŒ„æ‰¹æ”¹å®Œæˆ</h3>
                <form id="gradedForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®</label>
                            <select id="gradedSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜">å¸¸è­˜</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="ç§‘å­¸">ç§‘å­¸</option>
                                <option value="é›»è…¦">é›»è…¦</option>
                                <option value="ç­å‹™">ç­å‹™</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹æ”¹æ•¸é‡</label>
                            <input type="number" id="gradedCount" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="è«‹è¼¸å…¥æ‰¹æ”¹æ•¸é‡">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŠŸèª²é¡å‹</label>
                        <input type="text" id="gradedHomework" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="è«‹è¼¸å…¥æ‰¹æ”¹çš„åŠŸèª²é¡å‹">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">âœ… è¨˜éŒ„æ‰¹æ”¹</button>
                </form>
            </div>

            <!-- æ¯æœˆç¸½çµ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">ğŸ“Š æ¯æœˆç¸½çµ</h3>
                    <div class="flex space-x-2">
                        <button onclick="exportDailyToExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">ğŸ“¥ åŒ¯å‡ºç•¶æ—¥</button>
                        <button onclick="exportMonthlyToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">ğŸ“¥ åŒ¯å‡ºæ•´æœˆ</button>
                    </div>
                </div>
                <div id="monthlySummary" class="space-y-4">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>
        </div>

        <!-- è©³ç´°è¨˜éŒ„é é¢ -->
        <div id="detailPage" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="detailTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="showMainPage()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">â† è¿”å›ä¸»é </button>
                </div>
                <div id="detailContent" class="space-y-4">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">ç·¨è¼¯è¨˜éŒ„</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <input type="hidden" id="editType">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®</label>
                    <select id="editSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                        <option value="è‹±æ–‡">è‹±æ–‡</option>
                        <option value="æ•¸å­¸">æ•¸å­¸</option>
                        <option value="å¸¸è­˜">å¸¸è­˜</option>
                        <option value="äººæ–‡">äººæ–‡</option>
                        <option value="ç§‘å­¸">ç§‘å­¸</option>
                        <option value="é›»è…¦">é›»è…¦</option>
                        <option value="ç­å‹™">ç­å‹™</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div id="editFields">
                    <!-- å‹•æ…‹ç”Ÿæˆç·¨è¼¯æ¬„ä½ -->
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let currentDate = new Date().toISOString().split('T')[0];
        let currentMonth = new Date().toISOString().slice(0, 7);
        let currentDetailType = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('selectedDate').value = currentDate;
            document.getElementById('selectedMonth').value = currentMonth;
            loadData();
            loadMonthlyData();
            setupEventListeners();
        });

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ—¥æœŸè®Šæ›´
            document.getElementById('selectedDate').addEventListener('change', function() {
                currentDate = this.value;
                loadData();
            });

            // æœˆä»½è®Šæ›´
            document.getElementById('selectedMonth').addEventListener('change', function() {
                currentMonth = this.value;
                loadMonthlyData();
            });

            // é¸é …å¡åˆ‡æ›
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // è¡¨å–®æäº¤
            document.getElementById('homeworkForm').addEventListener('submit', handleHomeworkSubmit);
            document.getElementById('missingForm').addEventListener('submit', handleMissingSubmit);
            document.getElementById('gradedForm').addEventListener('submit', handleGradedSubmit);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
        }

        // åˆ‡æ›é¸é …å¡
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500');

            // é¡¯ç¤ºå°æ‡‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
        }

        // è™•ç†åŠŸèª²ç™¼ä½ˆ
        function handleHomeworkSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('homeworkSubject').value,
                content: document.getElementById('homeworkContent').value,
                dueDate: document.getElementById('homeworkDueDate').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('homework', data);
            document.getElementById('homeworkForm').reset();
            loadData();
            alert('åŠŸèª²ç™¼ä½ˆæˆåŠŸï¼');
        }

        // è™•ç†æ¬ äº¤è¨˜éŒ„
        function handleMissingSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('missingSubject').value,
                studentName: document.getElementById('studentName').value,
                homework: document.getElementById('missingHomework').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('missing', data);
            document.getElementById('missingForm').reset();
            loadData();
            alert('æ¬ äº¤è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        // è™•ç†æ‰¹æ”¹è¨˜éŒ„
        function handleGradedSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('gradedSubject').value,
                homework: document.getElementById('gradedHomework').value,
                count: document.getElementById('gradedCount').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('graded', data);
            document.getElementById('gradedForm').reset();
            loadData();
            alert('æ‰¹æ”¹è¨˜éŒ„å·²ä¿å­˜ï¼');
        }

        // ä¿å­˜è¨˜éŒ„
        function saveRecord(type, data) {
            const key = `${type}_${currentDate}`;
            let records = JSON.parse(localStorage.getItem(key) || '[]');
            records.push(data);
            localStorage.setItem(key, JSON.stringify(records));
        }

        // è¼‰å…¥æ•¸æ“š
        function loadData() {
            const homework = JSON.parse(localStorage.getItem(`homework_${currentDate}`) || '[]');
            const missing = JSON.parse(localStorage.getItem(`missing_${currentDate}`) || '[]');
            const graded = JSON.parse(localStorage.getItem(`graded_${currentDate}`) || '[]');

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('homeworkCount').textContent = homework.length;
            document.getElementById('missingCount').textContent = missing.length;
            document.getElementById('gradedCount').textContent = graded.reduce((sum, item) => sum + parseInt(item.count || 0), 0);

            // æ›´æ–°æ¯æ—¥ç¸½çµ
            updateDailySummary(homework, missing, graded);
        }

        // è¼‰å…¥æœˆä»½æ•¸æ“š
        function loadMonthlyData() {
            const monthlyData = getMonthlyRecords(currentMonth);
            updateMonthlySummary(monthlyData);
        }

        // ç²å–æœˆä»½è¨˜éŒ„
        function getMonthlyRecords(month) {
            const allRecords = { homework: [], missing: [], graded: [] };
            
            // ç²å–è©²æœˆä»½æ‰€æœ‰æ—¥æœŸçš„è¨˜éŒ„
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes(month)) {
                    const [type, date] = key.split('_');
                    if (['homework', 'missing', 'graded'].includes(type)) {
                        const records = JSON.parse(localStorage.getItem(key) || '[]');
                        records.forEach(record => {
                            record.recordDate = date; // æ·»åŠ è¨˜éŒ„æ—¥æœŸ
                        });
                        allRecords[type] = allRecords[type].concat(records);
                    }
                }
            }
            
            return allRecords;
        }

        // æ›´æ–°æ¯æœˆç¸½çµ
        function updateMonthlySummary(monthlyData) {
            const summaryDiv = document.getElementById('monthlySummary');
            let html = '';

            const totalHomework = monthlyData.homework.length;
            const totalMissing = monthlyData.missing.length;
            const totalGraded = monthlyData.graded.reduce((sum, item) => sum + parseInt(item.count || 0), 0);

            if (totalHomework === 0 && totalMissing === 0 && totalGraded === 0) {
                html = '<p class="text-gray-500 text-center py-8">æœ¬æœˆæš«ç„¡è¨˜éŒ„</p>';
            } else {
                // æœˆä»½çµ±è¨ˆ
                html += `<div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg mb-6">
                    <h4 class="font-bold text-lg mb-2">ğŸ“Š ${currentMonth} æœˆä»½çµ±è¨ˆ</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-white p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${totalHomework}</div>
                            <div class="text-sm text-gray-600">ç™¼ä½ˆåŠŸèª²</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg">
                            <div class="text-2xl font-bold text-red-600">${totalMissing}</div>
                            <div class="text-sm text-gray-600">æ¬ äº¤è¨˜éŒ„</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${totalGraded}</div>
                            <div class="text-sm text-gray-600">æ‰¹æ”¹æ•¸é‡</div>
                        </div>
                    </div>
                </div>`;

                // æŒ‰æ—¥æœŸåˆ†çµ„é¡¯ç¤º
                const dateGroups = {};
                ['homework', 'missing', 'graded'].forEach(type => {
                    monthlyData[type].forEach(record => {
                        if (!dateGroups[record.recordDate]) {
                            dateGroups[record.recordDate] = { homework: [], missing: [], graded: [] };
                        }
                        dateGroups[record.recordDate][type].push(record);
                    });
                });

                const sortedDates = Object.keys(dateGroups).sort().reverse();
                
                sortedDates.forEach(date => {
                    const dateData = dateGroups[date];
                    html += `<div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <h5 class="font-semibold text-lg mb-3 text-gray-800">ğŸ“… ${date}</h5>`;

                    // åŠŸèª²ç™¼ä½ˆ
                    if (dateData.homework.length > 0) {
                        html += '<div class="border-l-4 border-blue-500 pl-4 mb-3"><h6 class="font-medium text-blue-700 mb-2">ğŸ“ ç™¼ä½ˆåŠŸèª²</h6>';
                        dateData.homework.forEach(item => {
                            html += `<div class="bg-blue-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                                <div>
                                    <span class="font-medium">${item.subject}</span> - ${item.content}
                                    ${item.dueDate ? `<br><small class="text-gray-600">æˆªæ­¢ï¼š${item.dueDate}</small>` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editMonthlyRecord('homework', ${item.id}, '${date}')" class="text-blue-600 hover:text-blue-800">âœï¸</button>
                                    <button onclick="deleteMonthlyRecord('homework', ${item.id}, '${date}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    // æ¬ äº¤è¨˜éŒ„
                    if (dateData.missing.length > 0) {
                        html += '<div class="border-l-4 border-red-500 pl-4 mb-3"><h6 class="font-medium text-red-700 mb-2">âš ï¸ æ¬ äº¤è¨˜éŒ„</h6>';
                        dateData.missing.forEach(item => {
                            html += `<div class="bg-red-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                                <div>
                                    <span class="font-medium">${item.subject}</span> - ${item.studentName} æ¬ äº¤ï¼š${item.homework}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editMonthlyRecord('missing', ${item.id}, '${date}')" class="text-blue-600 hover:text-blue-800">âœï¸</button>
                                    <button onclick="deleteMonthlyRecord('missing', ${item.id}, '${date}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    // æ‰¹æ”¹è¨˜éŒ„
                    if (dateData.graded.length > 0) {
                        html += '<div class="border-l-4 border-green-500 pl-4"><h6 class="font-medium text-green-700 mb-2">âœ… æ‰¹æ”¹è¨˜éŒ„</h6>';
                        dateData.graded.forEach(item => {
                            html += `<div class="bg-green-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                                <div>
                                    <span class="font-medium">${item.subject}</span> - ${item.homework} (${item.count}ä»½)
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editMonthlyRecord('graded', ${item.id}, '${date}')" class="text-blue-600 hover:text-blue-800">âœï¸</button>
                                    <button onclick="deleteMonthlyRecord('graded', ${item.id}, '${date}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    html += '</div>';
                });
            }

            summaryDiv.innerHTML = html;
        }

        // é¡¯ç¤ºè©³ç´°é é¢
        function showDetailPage(type) {
            currentDetailType = type;
            const titles = {
                homework: 'ğŸ“ åŠŸèª²ç™¼ä½ˆè¨˜éŒ„',
                missing: 'âš ï¸ æ¬ äº¤è¨˜éŒ„ç®¡ç†',
                graded: 'âœ… æ‰¹æ”¹è¨˜éŒ„ç®¡ç†'
            };

            document.getElementById('detailTitle').textContent = titles[type];
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('detailPage').classList.remove('hidden');

            loadDetailRecords(type);
        }

        // è¼‰å…¥è©³ç´°è¨˜éŒ„
        function loadDetailRecords(type) {
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const detailContent = document.getElementById('detailContent');
            
            if (records.length === 0) {
                detailContent.innerHTML = '<p class="text-gray-500 text-center py-8">æš«ç„¡è¨˜éŒ„</p>';
                return;
            }

            let html = '<div class="space-y-4">';
            records.forEach(record => {
                html += `<div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">`;
                
                if (type === 'homework') {
                    html += `<h4 class="font-semibold text-lg">${record.subject}</h4>
                             <p class="text-gray-700 mt-1">${record.content}</p>
                             ${record.dueDate ? `<p class="text-sm text-gray-500 mt-2">æˆªæ­¢æ—¥æœŸï¼š${record.dueDate}</p>` : ''}`;
                } else if (type === 'missing') {
                    html += `<h4 class="font-semibold text-lg">${record.subject} - ${record.studentName}</h4>
                             <p class="text-gray-700 mt-1">æ¬ äº¤ï¼š${record.homework}</p>`;
                } else if (type === 'graded') {
                    html += `<h4 class="font-semibold text-lg">${record.subject}</h4>
                             <p class="text-gray-700 mt-1">${record.homework} (${record.count}ä»½)</p>`;
                }
                
                html += `<p class="text-xs text-gray-400 mt-2">è¨˜éŒ„æ™‚é–“ï¼š${record.timestamp}</p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editRecord('${type}', ${record.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">ç·¨è¼¯</button>
                            <button onclick="deleteRecord('${type}', ${record.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">åˆªé™¤</button>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            detailContent.innerHTML = html;
        }

        // é¡¯ç¤ºä¸»é é¢
        function showMainPage() {
            document.getElementById('detailPage').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            loadData();
        }

        // ç·¨è¼¯è¨˜éŒ„
        function editRecord(type, id) {
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const record = records.find(r => r.id === id);
            
            if (!record) return;

            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editSubject').value = record.subject;

            let fieldsHtml = '';
            if (type === 'homework') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŠŸèª²å…§å®¹</label>
                        <textarea id="editContent" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${record.content}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="editDueDate" value="${record.dueDate || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            } else if (type === 'missing') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å­¸ç”Ÿå§“å</label>
                        <input type="text" id="editStudentName" value="${record.studentName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¬ äº¤åŠŸèª²</label>
                        <input type="text" id="editHomework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            } else if (type === 'graded') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åŠŸèª²é¡å‹</label>
                        <input type="text" id="editHomework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹æ”¹æ•¸é‡</label>
                        <input type="number" id="editCount" value="${record.count}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            }

            document.getElementById('editFields').innerHTML = fieldsHtml;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // è™•ç†ç·¨è¼¯æäº¤
        function handleEditSubmit(e) {
            e.preventDefault();
            
            const type = document.getElementById('editType').value;
            const id = parseInt(document.getElementById('editId').value);
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex === -1) return;

            // æ›´æ–°è¨˜éŒ„
            records[recordIndex].subject = document.getElementById('editSubject').value;
            
            if (type === 'homework') {
                records[recordIndex].content = document.getElementById('editContent').value;
                records[recordIndex].dueDate = document.getElementById('editDueDate').value;
            } else if (type === 'missing') {
                records[recordIndex].studentName = document.getElementById('editStudentName').value;
                records[recordIndex].homework = document.getElementById('editHomework').value;
            } else if (type === 'graded') {
                records[recordIndex].homework = document.getElementById('editHomework').value;
                records[recordIndex].count = document.getElementById('editCount').value;
            }

            localStorage.setItem(`${type}_${currentDate}`, JSON.stringify(records));
            closeEditModal();
            
            if (currentDetailType) {
                loadDetailRecords(currentDetailType);
            } else {
                loadData();
            }
            
            // å¦‚æœç·¨è¼¯çš„æ˜¯æœˆä»½è¨˜éŒ„ï¼Œä¹Ÿè¦æ›´æ–°æœˆä»½ç¸½çµ
            loadMonthlyData();
            
            alert('è¨˜éŒ„å·²æ›´æ–°ï¼');
        }

        // é—œé–‰ç·¨è¼¯æ¨¡æ…‹æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // ç·¨è¼¯æœˆä»½è¨˜éŒ„
        function editMonthlyRecord(type, id, date) {
            const records = JSON.parse(localStorage.getItem(`${type}_${date}`) || '[]');
            const record = records.find(r => r.id === id);
            
            if (!record) return;

            // æš«æ™‚è¨­ç½®ç•¶å‰æ—¥æœŸç‚ºè¨˜éŒ„æ—¥æœŸï¼Œä»¥ä¾¿ç·¨è¼¯åŠŸèƒ½æ­£å¸¸å·¥ä½œ
            const originalDate = currentDate;
            currentDate = date;
            
            editRecord(type, id);
            
            // æ¢å¾©åŸå§‹æ—¥æœŸ
            currentDate = originalDate;
        }

        // åˆªé™¤æœˆä»½è¨˜éŒ„
        function deleteMonthlyRecord(type, id, date) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            
            const records = JSON.parse(localStorage.getItem(`${type}_${date}`) || '[]');
            const filteredRecords = records.filter(r => r.id !== id);
            localStorage.setItem(`${type}_${date}`, JSON.stringify(filteredRecords));
            
            loadMonthlyData();
            alert('è¨˜éŒ„å·²åˆªé™¤ï¼');
        }

        // åˆªé™¤è¨˜éŒ„
        function deleteRecord(type, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const filteredRecords = records.filter(r => r.id !== id);
            localStorage.setItem(`${type}_${currentDate}`, JSON.stringify(filteredRecords));
            
            if (currentDetailType) {
                loadDetailRecords(currentDetailType);
            } else {
                loadData();
            }
            
            alert('è¨˜éŒ„å·²åˆªé™¤ï¼');
        }

        // åŒ¯å‡ºç•¶æ—¥Excel
        function exportDailyToExcel() {
            const homework = JSON.parse(localStorage.getItem(`homework_${currentDate}`) || '[]');
            const missing = JSON.parse(localStorage.getItem(`missing_${currentDate}`) || '[]');
            const graded = JSON.parse(localStorage.getItem(`graded_${currentDate}`) || '[]');

            const wb = XLSX.utils.book_new();

            // åŠŸèª²ç™¼ä½ˆå·¥ä½œè¡¨
            if (homework.length > 0) {
                const homeworkData = homework.map(item => ({
                    'ç§‘ç›®': item.subject,
                    'åŠŸèª²å…§å®¹': item.content,
                    'æˆªæ­¢æ—¥æœŸ': item.dueDate || '',
                    'ç™¼ä½ˆæ™‚é–“': item.timestamp
                }));
                const ws1 = XLSX.utils.json_to_sheet(homeworkData);
                XLSX.utils.book_append_sheet(wb, ws1, 'åŠŸèª²ç™¼ä½ˆ');
            }

            // æ¬ äº¤è¨˜éŒ„å·¥ä½œè¡¨
            if (missing.length > 0) {
                const missingData = missing.map(item => ({
                    'ç§‘ç›®': item.subject,
                    'å­¸ç”Ÿå§“å': item.studentName,
                    'æ¬ äº¤åŠŸèª²': item.homework,
                    'è¨˜éŒ„æ™‚é–“': item.timestamp
                }));
                const ws2 = XLSX.utils.json_to_sheet(missingData);
                XLSX.utils.book_append_sheet(wb, ws2, 'æ¬ äº¤è¨˜éŒ„');
            }

            // æ‰¹æ”¹è¨˜éŒ„å·¥ä½œè¡¨
            if (graded.length > 0) {
                const gradedData = graded.map(item => ({
                    'ç§‘ç›®': item.subject,
                    'åŠŸèª²é¡å‹': item.homework,
                    'æ‰¹æ”¹æ•¸é‡': item.count,
                    'è¨˜éŒ„æ™‚é–“': item.timestamp
                }));
                const ws3 = XLSX.utils.json_to_sheet(gradedData);
                XLSX.utils.book_append_sheet(wb, ws3, 'æ‰¹æ”¹è¨˜éŒ„');
            }

            if (wb.SheetNames.length === 0) {
                alert('ä»Šæ—¥æš«ç„¡è¨˜éŒ„å¯åŒ¯å‡ºï¼');
                return;
            }

            XLSX.writeFile(wb, `åŠŸèª²ç®¡ç†è¨˜éŒ„_${currentDate}.xlsx`);
        }

        // åŒ¯å‡ºæ•´æœˆExcel
        function exportMonthlyToExcel() {
            const monthlyData = getMonthlyRecords(currentMonth);
            const wb = XLSX.utils.book_new();

            // åŠŸèª²ç™¼ä½ˆå·¥ä½œè¡¨
            if (monthlyData.homework.length > 0) {
                const homeworkData = monthlyData.homework.map(item => ({
                    'æ—¥æœŸ': item.recordDate,
                    'ç§‘ç›®': item.subject,
                    'åŠŸèª²å…§å®¹': item.content,
                    'æˆªæ­¢æ—¥æœŸ': item.dueDate || '',
                    'ç™¼ä½ˆæ™‚é–“': item.timestamp
                }));
                const ws1 = XLSX.utils.json_to_sheet(homeworkData);
                XLSX.utils.book_append_sheet(wb, ws1, 'åŠŸèª²ç™¼ä½ˆ');
            }

            // æ¬ äº¤è¨˜éŒ„å·¥ä½œè¡¨
            if (monthlyData.missing.length > 0) {
                const missingData = monthlyData.missing.map(item => ({
                    'æ—¥æœŸ': item.recordDate,
                    'ç§‘ç›®': item.subject,
                    'å­¸ç”Ÿå§“å': item.studentName,
                    'æ¬ äº¤åŠŸèª²': item.homework,
                    'è¨˜éŒ„æ™‚é–“': item.timestamp
                }));
                const ws2 = XLSX.utils.json_to_sheet(missingData);
                XLSX.utils.book_append_sheet(wb, ws2, 'æ¬ äº¤è¨˜éŒ„');
            }

            // æ‰¹æ”¹è¨˜éŒ„å·¥ä½œè¡¨
            if (monthlyData.graded.length > 0) {
                const gradedData = monthlyData.graded.map(item => ({
                    'æ—¥æœŸ': item.recordDate,
                    'ç§‘ç›®': item.subject,
                    'åŠŸèª²é¡å‹': item.homework,
                    'æ‰¹æ”¹æ•¸é‡': item.count,
                    'è¨˜éŒ„æ™‚é–“': item.timestamp
                }));
                const ws3 = XLSX.utils.json_to_sheet(gradedData);
                XLSX.utils.book_append_sheet(wb, ws3, 'æ‰¹æ”¹è¨˜éŒ„');
            }

            // æœˆä»½çµ±è¨ˆå·¥ä½œè¡¨
            const totalHomework = monthlyData.homework.length;
            const totalMissing = monthlyData.missing.length;
            const totalGraded = monthlyData.graded.reduce((sum, item) => sum + parseInt(item.count || 0), 0);

            const summaryData = [
                { 'çµ±è¨ˆé …ç›®': 'ç™¼ä½ˆåŠŸèª²ç¸½æ•¸', 'æ•¸é‡': totalHomework },
                { 'çµ±è¨ˆé …ç›®': 'æ¬ äº¤è¨˜éŒ„ç¸½æ•¸', 'æ•¸é‡': totalMissing },
                { 'çµ±è¨ˆé …ç›®': 'æ‰¹æ”¹ç¸½æ•¸é‡', 'æ•¸é‡': totalGraded }
            ];
            const ws4 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws4, 'æœˆä»½çµ±è¨ˆ');

            if (wb.SheetNames.length === 0) {
                alert('æœ¬æœˆæš«ç„¡è¨˜éŒ„å¯åŒ¯å‡ºï¼');
                return;
            }

            XLSX.writeFile(wb, `åŠŸèª²ç®¡ç†è¨˜éŒ„_${currentMonth}.xlsx`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9826b489456e04ec',t:'MTc1ODQyNzc0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
